name: Lock comments on closed issues

on:
  issues:
    types: [closed]
  workflow_dispatch:

jobs:
  lock-comments:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: 14

    - name: Install dependencies
      run: npm install @octokit/rest

    - name: Lock comments on closed issue
      run: |
        const { Octokit } = require("@octokit/rest");
        const octokit = new Octokit({
          auth: process.env.GITHUB_TOKEN
        });

        async function lockIssueComments(octokit, owner, repo, issue_number) {
          const issue = await octokit.issues.get({
            owner,
            repo,
            issue_number
          });

          if (issue.data.state === "closed") {
            await octokit.issues.update({
              owner,
              repo,
              issue_number,
              state: "closed",
              lock_reason: "off-topic"
            });
          }
        }

        const [owner, repo] = process.env.GITHUB_REPOSITORY.split("/");
        const issue_number = process.env.GITHUB_EVENT_NAME.split("/")[1];
        lockIssueComments(octokit, owner, repo, issue_number);

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
